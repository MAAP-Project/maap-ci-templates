name: Git-Flow PR Validation

on:
  workflow_call:
    inputs:
      custom_allowed_patterns:
        description: 'Optional custom patterns to allow (YAML list format)'
        required: false
        type: string
        default: ''

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR source and target branches
        run: |
          SOURCE="${{ github.event.pull_request.head.ref }}"
          TARGET="${{ github.event.pull_request.base.ref }}"

          echo "üîç Validating PR: $SOURCE ‚Üí $TARGET"

          # Parse custom patterns if provided
          if [[ -n "${{ inputs.custom_allowed_patterns }}" ]]; then
            echo "Using custom allowed patterns in addition to GitFlow defaults"
            # Custom pattern handling would go here
          fi

          # GitFlow rules
          if [[ "$SOURCE" == feature/* && "$TARGET" == "develop" ]]; then
            echo "‚úÖ Feature branch merging into develop ‚Äî OK"
            exit 0
          elif [[ "$SOURCE" == bugfix/* && "$TARGET" == "develop" ]]; then
            echo "‚úÖ Bugfix branch merging into develop ‚Äî OK"
            exit 0
          elif [[ "$SOURCE" == bugfix/* && "$TARGET" == release/* ]]; then
            echo "‚úÖ Bugfix branch merging into release ‚Äî OK"
            exit 0
          elif [[ "$SOURCE" == "develop" && "$TARGET" == release/* ]]; then
            echo "‚úÖ Develop merging into release ‚Äî OK"
            exit 0
          elif [[ "$SOURCE" == release/* && "$TARGET" == "main" ]]; then
            echo "‚úÖ Release merging into main ‚Äî OK"
            exit 0
          elif [[ "$SOURCE" == release/* && "$TARGET" == "develop" ]]; then
            echo "‚úÖ Release merging back into develop ‚Äî OK"
            exit 0
          elif [[ "$SOURCE" == hotfix/* && "$TARGET" == "main" ]]; then
            echo "‚úÖ Hotfix merging into main ‚Äî OK"
            exit 0
          elif [[ "$SOURCE" == "main" && "$TARGET" == "develop" ]]; then
            echo "‚úÖ Main merging back into develop ‚Äî OK"
            exit 0
          else
            echo "‚ùå Invalid Git-Flow PR direction: $SOURCE ‚Üí $TARGET"
            echo "   Allowed combinations:"
            echo "   - feature/*  ‚Üí develop"
            echo "   - bugfix/*   ‚Üí develop"
            echo "   - bugfix/*   ‚Üí release/*"
            echo "   - develop    ‚Üí release/*"
            echo "   - release/*  ‚Üí main"
            echo "   - release/*  ‚Üí develop"
            echo "   - hotfix/*   ‚Üí main"
            echo "   - main       ‚Üí develop"
            exit 1
          fi
